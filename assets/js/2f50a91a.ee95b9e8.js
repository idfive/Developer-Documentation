"use strict";(self.webpackChunkidfive_docs=self.webpackChunkidfive_docs||[]).push([[921],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),d=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=d(e.components);return n.createElement(l.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=d(a),h=r,m=u["".concat(l,".").concat(h)]||u[h]||p[h]||s;return a?n.createElement(m,o(o({ref:t},c),{},{components:a})):n.createElement(m,o({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=a.length,o=new Array(s);o[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:r,o[1]=i;for(var d=2;d<s;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},2644:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var n=a(7462),r=(a(7294),a(3905));const s={},o="Drupal Updates",i={unversionedId:"back-end/drupal/drupal-updates",id:"back-end/drupal/drupal-updates",title:"Drupal Updates",description:"Core Updates",source:"@site/docs/back-end/drupal/drupal-updates.md",sourceDirName:"back-end/drupal",slug:"/back-end/drupal/drupal-updates",permalink:"/docs/back-end/drupal/drupal-updates",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/back-end/drupal/drupal-updates.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Testing in drupal",permalink:"/docs/back-end/drupal/drupal-testing"},next:{title:"Drupal Users and Roles",permalink:"/docs/back-end/drupal/drupal-users-roles"}},l={},d=[{value:"Core Updates",id:"core-updates",level:2},{value:"Sample core update workflow",id:"sample-core-update-workflow",level:3},{value:"General things to look at when performing core updates",id:"general-things-to-look-at-when-performing-core-updates",level:3},{value:"Scaffolding tips for core composer.json, for easier updates",id:"scaffolding-tips-for-core-composerjson-for-easier-updates",level:3},{value:"Exclude .htaccess changes",id:"exclude-htaccess-changes",level:4},{value:"Contrib Updates",id:"contrib-updates",level:2},{value:"Sample contrib update workflow",id:"sample-contrib-update-workflow",level:3},{value:"General things to look at when performing contrib updates",id:"general-things-to-look-at-when-performing-contrib-updates",level:3},{value:"A @sites alias replacement for drush 9 and above",id:"a-sites-alias-replacement-for-drush-9-and-above",level:2},{value:"Example script on a server, scripts/idfive_sites.sh",id:"example-script-on-a-server-scriptsidfive_sitessh",level:3},{value:"Usage of idfive_sites.sh directly",id:"usage-of-idfive_sitessh-directly",level:3},{value:"Usage of idfive_sites.sh from a scripting library",id:"usage-of-idfive_sitessh-from-a-scripting-library",level:3}],c={toc:d},u="wrapper";function p(e){let{components:t,...a}=e;return(0,r.kt)(u,(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"drupal-updates"},"Drupal Updates"),(0,r.kt)("h2",{id:"core-updates"},"Core Updates"),(0,r.kt)("p",null,"Core updates are to be enacted with composer. Though some scaffolding systems may vary, ",(0,r.kt)("inlineCode",{parentName:"p"},"composer update drupal/core --with-dependencies")," is normally what is called for."),(0,r.kt)("h3",{id:"sample-core-update-workflow"},"Sample core update workflow"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Backup Database/etc as needed."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'composer outdated "drupal/*"')," Shows if core/contrib is out of date."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"composer update drupal/core --with-dependencies")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"drush updb")," Update local DB, if required."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"drush cr")," Clear caches."),(0,r.kt)("li",{parentName:"ul"},"Test locally"),(0,r.kt)("li",{parentName:"ul"},"If using config sync, run ",(0,r.kt)("inlineCode",{parentName:"li"},"drush cex sync"),"."),(0,r.kt)("li",{parentName:"ul"},"Commit, deploy, test on dev/stg/prod, as needed, per client specs.")),(0,r.kt)("h3",{id:"general-things-to-look-at-when-performing-core-updates"},"General things to look at when performing core updates"),(0,r.kt)("p",null,"In general, minor core updates are usually not an issue. Most often, these are changes to underlying libraries like Symphony, or security updates, or bug fixes to existing functionality."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Look at your composer.json. Are their any patches active for core? Do they still apply?"),(0,r.kt)("li",{parentName:"ul"},"Look at the release notes for the new core version. Any red flags? Any open issues?"),(0,r.kt)("li",{parentName:"ul"},"Do the release notes mention changes to specific functionality? If so, flag for testing."),(0,r.kt)("li",{parentName:"ul"},"Does the new release require updates to the database?")),(0,r.kt)("h3",{id:"scaffolding-tips-for-core-composerjson-for-easier-updates"},"Scaffolding tips for core composer.json, for easier updates"),(0,r.kt)("h4",{id:"exclude-htaccess-changes"},"Exclude .htaccess changes"),(0,r.kt)("p",null,"The following, when added to to the core scaffold, ignores .htaccess changes, where we often store global redirects/etc."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"extra": {\n  "drupal-scaffold": {\n    "file-mapping": {\n      "[web-root]/.htaccess": false\n    }\n  }\n}\n')),(0,r.kt)("h2",{id:"contrib-updates"},"Contrib Updates"),(0,r.kt)("p",null,"Contrib updates are to be enacted with composer. Though some scaffolding systems may vary, ",(0,r.kt)("inlineCode",{parentName:"p"},"composer update drupal/MODULE_NAME --with-dependencies")," is normally what is called for."),(0,r.kt)("h3",{id:"sample-contrib-update-workflow"},"Sample contrib update workflow"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Backup Database/etc as needed."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'composer outdated "drupal/*"')," Shows if core/contrib is out of date."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"composer update drupal/* --with-dependencies")," Will update all (including core if it needs it)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"composer update drupal/MODULE_NAME")," will do a specific module."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"drush updb")," Update local DB, if required."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"drush cr")," Clear caches."),(0,r.kt)("li",{parentName:"ul"},"Test locally"),(0,r.kt)("li",{parentName:"ul"},"If using config sync, run ",(0,r.kt)("inlineCode",{parentName:"li"},"drush cex sync"),"."),(0,r.kt)("li",{parentName:"ul"},"Commit, deploy, test on dev/stg/prod, as needed, per client specs.")),(0,r.kt)("h3",{id:"general-things-to-look-at-when-performing-contrib-updates"},"General things to look at when performing contrib updates"),(0,r.kt)("p",null,'In general, contrib updates are "less trustworthy" than core updates. They are sometimes best done, and tested one at a time for significant updates, especially if jumping several versions, or major versions.'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Is this a minor, or major update?"),(0,r.kt)("li",{parentName:"ul"},"If major, any release notes regarding an upgrade path?"),(0,r.kt)("li",{parentName:"ul"},"Does this module rely on any libraries that also need updating?"),(0,r.kt)("li",{parentName:"ul"},"Does this have any conflicts with current core version. (shouldn't, if done via composer)")),(0,r.kt)("h2",{id:"a-sites-alias-replacement-for-drush-9-and-above"},"A @sites alias replacement for drush 9 and above"),(0,r.kt)("p",null,"Since drush 9 and above does away with the @sites alias, we needed to create a script on the server that essentially loops through all sites on a multi-site install, and runs drush commands/etc. This script is located in each codebase, under ",(0,r.kt)("inlineCode",{parentName:"p"},"scripts/idfive_sites.sh"),". It is interacted with, both through command line/etc, and via CRON scheduled jobs on acquia/similar. For scheduled jobs, see the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.acquia.com/cloud-platform/manage/cron/#cloud-execute-shell-script"},"acquia documentation"),". At its essence, it provides a way to run the same drush command on all multi-sites within an environment."),(0,r.kt)("p",null,"Note below scripts run on acquia:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Therefore use one of their vars, ",(0,r.kt)("inlineCode",{parentName:"li"},"${AH_SITE_NAME}"),", which would need to be modified if used elesewhere."),(0,r.kt)("li",{parentName:"ul"},"includes ",(0,r.kt)("inlineCode",{parentName:"li"},'awk \'{print "["strftime("\\%Y-\\%m-\\%d \\%H:\\%M:\\%S \\%Z")"] "$0}\' &>> /var/log/sites/${AH_SITE_NAME}/logs/$(hostname -s)/drush-cron.log')," only because acquia requires logging for scripts. This can easily be removed elsewhere.")),(0,r.kt)("h3",{id:"example-script-on-a-server-scriptsidfive_sitessh"},"Example script on a server, scripts/idfive_sites.sh"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'  #!/bin/bash\n\n  # Provide the absolute path to the sites directory.\n  SITES="/var/www/html/${AH_SITE_NAME}/docroot/sites"\n\n  # Validate and hint if no argument provided.\n  if [ "${#}" -eq 0 ]; then\n    echo "drush: missing argument(s). Please add the drush command you wish to run on all sites."\n    echo "The \'drush\' will be added automatically, please only add the actual command desired. EXAMPLE: cex -y"\n  else\n    cd "${SITES}"\n    # Loop:\n    for SITE in $(ls -d */ | cut -f1 -d\'/\'); do\n      # Skip default sites, only run for howard url\'s.\n      if [[ "${SITE}" == *".howard.edu"* ]]; then\n        echo "======================================"\n        echo "Running command: drush -l ${SITE} ${@} -y"\n        echo "======================================"\n        drush -l "${SITE}" "${@}" -y | awk \'{print "["strftime("\\%Y-\\%m-\\%d \\%H:\\%M:\\%S \\%Z")"] "$0}\' &>> /var/log/sites/${AH_SITE_NAME}/logs/$(hostname -s)/drush-cron.log\n      fi\n    done\n  fi\n')),(0,r.kt)("h3",{id:"usage-of-idfive_sitessh-directly"},"Usage of idfive_sites.sh directly"),(0,r.kt)("p",null,'When running this script, \'drush\' and the \'-y\' flag, are automatically added to the drush command you wish to run. It is quite important to "not use command aliases" with this script. Ie, use "pm:enable" not "en". Related too ',(0,r.kt)("a",{parentName:"p",href:"https://github.com/drush-ops/drush/issues/3025"},"this issue")," if curious as to why."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"From root folder on acquia server, check status: ",(0,r.kt)("inlineCode",{parentName:"li"},"bash scripts/idfive_sites.sh status"),". In this instance, 'status' is the drush command to run."),(0,r.kt)("li",{parentName:"ul"},"From root folder on acquia server, clear cache: ",(0,r.kt)("inlineCode",{parentName:"li"},"bash scripts/idfive_sites.sh cr"),". In this instance, 'cr' is the drush command to run."),(0,r.kt)("li",{parentName:"ul"},"From scheduled task runner on acquia: ",(0,r.kt)("inlineCode",{parentName:"li"},"bash /var/www/html/${AH_SITE_NAME}/scripts/idfive_sites.sh cr"),". Clears caches on all sites in install, to run hourly or whatever desired.")),(0,r.kt)("h3",{id:"usage-of-idfive_sitessh-from-a-scripting-library"},"Usage of idfive_sites.sh from a scripting library"),(0,r.kt)("p",null,"An example local script from the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/howard-university-web-services/Howard-Automation-Library"},"Howard Automation Library"),", to interact with a few acquia multisites, and run drush commands for each:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash\n#\n# Update specific config on all howard D8 Sites.\n#\n# $ sh ~/Sites/_hal/drupal/acquia/update_via_drush.sh\n#\n# Notes:\n# - See README.md for detailed instructions.\n# - Allows drush commands to be run on all sites and environments.\n#\n# Dependencies:\n# - drush\n#\n# Parameters:\n# - Drush command | ie, pm-uninstall page_cache\n#\n\necho "Updating custom config for Howard D8 sites."\n\nsource ~/Sites/_hal/hal_config.txt\n\n# Choose acquia env for drush aliases\necho "Please choose which acquia env to run this on:"\nENVS=(".dev.dev" ".test.test" ".prod.prod")\nselect ENV in "${ENVS[@]}"\ndo\n  echo "$ENV selected"\n  break\ndone\n\n# Config Name, use as $DRUSH_COMMAND\necho "Enter the drush command. (e.g. pm:enable page_cache):"\nread DRUSH_COMMAND\n\n# Check Config Name is not empty\nif [ -z "$DRUSH_COMMAND" ]; then\n  echo "The drush command cannot be empty!"\n  exit 2\nfi\n\n# Foreach drush alias, go on the server and set.\nfor APP in ${LOCAL_HOWARD_D8_DRUSH_ALIAS[@]}; do\n  echo "Running config updates for $APP$ENV"\n  drush $APP$ENV ssh "bash /var/www/html/"\\${AH_SITE_NAME}"/scripts/hal_sites.sh $DRUSH_COMMAND"\ndone\n\necho "drush updates complete on $APP$ENV."\n\nexit 0\n')))}p.isMDXComponent=!0}}]);